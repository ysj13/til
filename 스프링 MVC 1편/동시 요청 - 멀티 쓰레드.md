# 멀티 쓰레드
## 쓰레드
* 애플리케이션 코드를 하나하나 순차적으로 실행하는것은 쓰레드
* 자바 메인 메서드를 처음 실행하면 main 이라는 이름의 쓰레드가 실행된다.
* 쓰레드가 없다면 자바 어플리케이션 실행이 불가능하다.
* 쓰레드는 한번에 하나의 코드 라인만 수행한다.
* 동시 처리가 필요하다면 쓰레드를 추가로 생성해야 한다.

### 단일 요청 - 쓰레드 하나 사용
요청이 들어오면 쓰레드를 할당하고 이 쓰레드를 가지고 Servlet 코드를 실행하게 된다.

### 다중 요청  - 쓰레드 하나 사용
하나의 쓰레드를 가지고 요청(1)을 처리하는데 처리가 지연되고 있다.
이 때 다른 요청(2) 이 들어온다면?
=> 요청(1)이 처리되기 전까지 요청(2)는 계속 대기하게 되며,  
요청(1)이 처리되지 않을 경우 요청1, 2 모두 Timeout이 발생하게 되어 처리가 실패하게 된다.

### 요청 마다 쓰레드 생성
요청이 들어올 때 마다 쓰레드를 생성하여 요청을 처리하는 방식으로 위의 문제를 해결할 수 있다.
하지만 요청이 들어올때마다 쓰레드를 생성하게 되면 다음과 같은 문제가 발생하게 된다.

### 요청마다 쓰레드 생성 시 장단점
* 장점
	* 동시 요청을 처리할 수 있다.
	* 리소스가 허용하는 한도안에서 계속 처리가 가능하다.
	* 하나의 쓰레드가 지연되어도, 나머지 쓰레드는 정상 동작 한다.
* 단점
	* 쓰레드의 생성 비용은 매우 비싸다.
		* 고객의 요청이 들어올때 마다 쓰레드를 생성하면, 응답속도가 늦어진다.
	* 쓰레드는 컨텍스트 스위칭 비용이 발생한다.
	* 쓰레드 생성에 제한이 없다.
		* 고객 요청이 너무 많이 들어오면, CPU, 메모리 임계점을 넘어 서버가 다운될 수 있다.

## 쓰레드 풀
요청마다 쓰레드를 생성하는 방식의 단점을 보완하기 위해 쓰레드 풀이라는것을 사용한다. Pool 안에 쓰레드를 미리 여러개 만들어 놓고 요청이 들어올때 마다 쓰레드를 빌려주는 개념이다. 
쓰레드를 다 사용하고 나면 쓰레드가 종료되는것이 아니라 다시 쓰레드 풀에 반납하게 된다.

* 특징
	* 필요한 쓰레드를 쓰레드 풀에 보관하고 관리한다.
	*  쓰레드 풀에 생성 가능한 쓰레드의 최대치를 관리한다. 톰캣은 최대 200개 기본 설정
* 사용
	* 쓰레드가 필요하면, 이미 생성되어 있는 쓰레드를 쓰레드 풀에서 꺼내서 사용한다.
	* 사용을 종료하면 쓰레드 풀에 해당 쓰레드를 반납한다.
	* 최대 쓰레드가 모두 사용중이여서 쓰레드 풀에 쓰레드가 없다면?
		* 새로 들어오는 요청은 거절하거나 대기하도록 설정할 수 있다.
* 장점
	* 쓰레드가 미리 생성되어 있으므로, 쓰레드를 생성하고 종료하는 비용이 절약되며, 응답시간도 개선된다.
	* 생성 가능한 쓰레드의 최대치가 정해져 있으므로 너무 많은 요청이 들어와도 기존의 요청은 안전하게 처리할 수 있다.(식당 웨이팅을 생각해보면 된다.)

## WAS 의 멀티 쓰레드 지원
* 멀티 쓰레드의 대한 부분은 WAS가 처리한다.
* 개발자가 멀티 쓰레드 관련 코드를 신경쓰지 않아도 됨
* 개발자는 마치 싱글쓰레드 프로그래밍을 하듯 비즈니스 로직을 작성하면 된다.
* 멀티 쓰레드 환경이므로 싱글톤 객체(서블릿, 스프링 빈)를 주의해서 사용하자.
